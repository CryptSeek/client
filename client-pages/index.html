<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CryptSeek</title>
        <link rel="stylesheet" href="./styles.css">
    </head>

    <body>
        <div class="body-flex">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2>My Messages</h2>
                <div id="user-list">
                    <p>
                        <!-- Links generated by loaded messages -->
                    </p>
                </div>
            </div>

            <!-- Main content -->

            <!-- Navbar -->
            <div class="main-content">
                <nav class="top-nav">
                    <img src="./logo.png" style="width: 200px; text-align: left;"
                        alt="CryptSeek Logo">
                    <div style="text-align: right;">
                        <a class="top-nav-item" href="friends.html#cs-add-friend">Friends</a>
                        <a class="top-nav-item" href="settings.html">Settings</a>
                    </div>
                </nav>

                <div class="message-content-area">
                    <div id="message-log">
                        <!-- Generate areas based on received message senders -->
                    </div>
                </div>

                <div id="message-input-area">
                    <label for="message"></label><input id="message" type="text" placeholder="Enter a message">
                    <button id="send-message-button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>

            </div>
        </div>

        <script>
        // Make the send button respond to pressing enter
        const sendButton = document.getElementById('send-message-button');

        document.addEventListener('keypress', (event) => {
            if (event.code === 'Enter') {
                sendButton.click();
            }
        });



        const { ipcRenderer } = require("electron");
        const Store = require('electron-store');
        const fs = require('fs');
        const Dialogs = require('dialogs');
        const dialogs = Dialogs();

        // DOM objects for showing messages
        const logArea = document.getElementById('message-log');
        const userList = document.getElementById('user-list').children[0];

        const store = new Store();
        const bouncerAddress = store.get('bouncerAddress');
        const gatewayAddress = store.get('gatewayAddress');
        const username = store.get('username');

        // Persistent File handling
        let dataPath = '';
        ipcRenderer.on('path-relay', (event, data) => {
            dataPath = data['data'];
            loadStoredMessages();
        });

        if (dataPath === '') {
            ipcRenderer.send('get-path');
        }

        function loadStoredMessages() {
            let friends = fs.readdirSync(`${dataPath}/data`);
            friends.forEach((friendPath) => {
                fs.readFile(`${dataPath}/data/${friendPath}/messages.jsonl`, {encoding: 'utf-8'}, (err, data) => {
                    if (!err) {
                        let messages = data.split('\n');
                        messages.forEach(message => {
                            try {
                                const obj = JSON.parse(message);
                                const sender = obj['sender'];
                                const recipient = obj['recipient'];
                                const content = obj['message'];
                                const key = obj['key'];
                                receiveMessage(sender, recipient, content, key)
                            } catch {
                                console.log('error processing data: ' + message.toString());
                            }
                        });
                    }
                });
            });
        }

        // This function sends messages to the bouncer
        async function sendMessage() {
            let recipient = document.querySelector("#recipient")?.value || location.href.split('#')[1];
            if (!recipient) return;

            const plaintext = document.getElementById("message").value;

            // Encrypt full message object (sender, recipient, message)
            const messageObject = {
                sender: username,
                recipient: recipient,
                message: plaintext
            };

            ipcRenderer.send('send-message', messageObject);

            // Clear input field
            document.getElementById("message").value = '';

            // TODO add error checking
            const keyFilePath = `${dataPath}/data/${recipient}/key`;
            if (!fs.existsSync(keyFilePath)) {
                dialogs.alert("You don't have a secure key for this friend yet. Make sure they accepted your request.")
            }
        }

        function receiveMessage(sender, recipient, message, newRequest) {

            console.log("Processing message from:" + sender + " to " + recipient);

            let bounceBack = false; // bounceBack indicates if the message was sent from this client and bounced back from the server
            if (sender === username) { // message sent BY user
                bounceBack = true;
            }


            // Find the convo if it exists
            let existingConvoFound = false;
            let convo;
            Array.from(logArea.children).forEach((elem) => {

                // filter by the recipient if the message was sent by the client
                if (bounceBack && elem.id === recipient) {
                    existingConvoFound = true;
                    convo = elem;
                }

                else if (elem.id === sender) {
                    existingConvoFound = true;
                    convo = elem;
                }
            })

            // If the convo does not already exist, make a new one
            if (!existingConvoFound) {

                // Ensure convo target matches the remote user
                if (bounceBack) {
                    let newUser = document.createElement('div');
                    newUser.id = recipient;
                    newUser.classList.add('user-log');
                    newUser.innerHTML = "<h3>Chat history with <span>" + recipient + "</span></h3><ul class='message-log'></ul>";
                    convo = newUser;
                    logArea.appendChild(newUser);

                    let userLink = document.createElement('p');
                    userLink.innerHTML = `<a class="side-nav-item" href="#${recipient}">${recipient}</a>`;
                    userList.appendChild(userLink);
                }
                else {
                    let newUser = document.createElement('div');
                    newUser.id = sender;
                    newUser.classList.add('user-log');
                    newUser.innerHTML = "<h3>Chat history with <span>" + sender + "</span></h3><ul class='message-log'></ul>";
                    convo = newUser;
                    logArea.appendChild(newUser);

                    let userLink = document.createElement('p');
                    userLink.innerHTML = `<a class="side-nav-item" href="#${sender}">${sender}</a>`;
                    userList.appendChild(userLink);
                }
            }

            // Append the message to the conversation
            let newMessage = document.createElement('li');
            if (bounceBack) {
                newMessage.classList.add('own-message');
            }

            let innerP = document.createElement('p');
            innerP.innerText = message;

            newMessage.appendChild(innerP);

            // Add options for friend request
            if (newRequest) {
                const acceptButton = document.createElement('button');
                const blockButton = document.createElement('button');

                acceptButton.id = `accept-${sender}`;
                blockButton.id = `block-${sender}`;

                acceptButton.innerText = "Accept";
                blockButton.innerText = "Block";

                acceptButton.classList.add('btn', 'btn-green');
                blockButton.classList.add('btn', 'btn-warning');

                acceptButton.onclick = (event) => {
                    const name = event.target.id.split('-')[1];
                    const statusFile = `${dataPath}/data/${name}/status`;
                    fs.writeFileSync(statusFile, JSON.stringify({status: 3}));

                    const messageFile = `${dataPath}/data/${name}/messages.jsonl`;
                    const request = JSON.parse(fs.readFileSync(messageFile).toString());
                    request['key'] = false;
                    fs.writeFileSync(messageFile, JSON.stringify(request));

                    event.target.nextSibling.remove();
                    event.target.remove();
                }

                blockButton.addEventListener('click', (event) => {
                    const name = event.target.id.split('-')[1];
                    const statusFile = `${dataPath}/data/${name}/status`;
                    fs.writeFileSync(statusFile, JSON.stringify({status: 4}));

                    const messageFile = `${dataPath}/data/${name}/messages.jsonl`;
                    fs.truncateSync(messageFile, 0);

                    event.target.parentNode.remove();
                });

                newMessage.appendChild(acceptButton);
                newMessage.appendChild(blockButton);
            }

            if (convo.children[1].firstChild) {  // Existing messages
                convo.children[1].insertBefore(newMessage, convo.children[1].firstChild);
            }
            else {  // new convo
                convo.children[1].appendChild(newMessage);
            }

            // Adjust scroll if currently targeting the convo
            if (location.href.split('#')[1] === convo.id) {
                convo.children[1].scrollTop = convo.children[1].scrollHeight;
            }
        }

        // Puts new messages up in the response area
        ipcRenderer.on("message-received", (event, messageObj) => {
            const sender = messageObj['sender'];
            const recipient = messageObj['recipient'];
            const content = messageObj['message'];
            const key = messageObj['key'];

            receiveMessage(sender, recipient, content, key)
        });
    </script>
    </body>
</html>
