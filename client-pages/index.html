<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CryptSeek</title>
        <link rel="stylesheet" href="./styles.css">
    </head>

    <body>
        <div class="body-flex">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2>My Messages</h2>
                <div id="user-list">
                    <p>
                        <!-- Links generated by loaded messages -->
                    </p>
                </div>
            </div>

            <!-- Main content -->

            <!-- Navbar -->
            <div class="main-content">
                <nav class="top-nav">
                    <img src="./logo.png" style="width: 200px; text-align: left;"
                        alt="CryptSeek Logo">
                    <div style="text-align: right;">
                        <a class="top-nav-item" href="friends.html">Friends</a>
                        <a class="top-nav-item" href="settings.html">Settings</a>
                    </div>
                </nav>

                <div class="message-content-area">
                    <!-- Debug Box -->
                    <div class="info-box">
                        <h3 style="margin: 5px 0 15px 0; text-align: center;">Debug Field Area</h3>
                        <label for="recipient">Recipient: </label>
                        <input type="text" id="recipient"
                            placeholder="Username of recipient">
                    </div>

                    <div id="message-log">
                        <!-- Generate areas based on received message senders -->
                    </div>
                </div>

                <div id="message-input-area">
                    <label for="message"></label><input id="message" type="text" placeholder="Enter a message">
                    <button id="send-message-button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>

            </div>
        </div>

        <script>
        // Make the send button respond to pressing enter
        const sendButton = document.getElementById('send-message-button');

        document.addEventListener('keypress', (event) => {
            if (event.code === 'Enter') {
                sendButton.click();
            }
        });



        const { ipcRenderer } = require("electron");
        const Store = require('electron-store');
        const fs = require('fs');

        // DOM objects for showing messages
        const logArea = document.getElementById('message-log');
        const userList = document.getElementById('user-list').children[0];

        const store = new Store();
        const bouncerAddress = store.get('bouncerAddress');
        const gatewayAddress = store.get('gatewayAddress');
        const username = store.get('username');

        // Persistent File handling
        let dataPath = '';
        ipcRenderer.on('path-relay', (event, data) => {
            dataPath = data['data'];
            loadStoredMessages();
        });

        if (dataPath === '') {
            ipcRenderer.send('get-path');
        }

        function loadStoredMessages() {
            let friends = fs.readdirSync(`${dataPath}/data`);
            friends.forEach((friendPath) => {
                fs.readFile(`${dataPath}/data/${friendPath}/messages.jsonl`, {encoding: 'utf-8'}, (err, data) => {
                    if (!err) {
                        let messages = data.split('\n');
                        messages.forEach(message => {
                            try {
                                const obj = JSON.parse(message);
                                const sender = obj['sender'];
                                const recipient = obj['recipient'];
                                const content = obj['message'];
                                receiveMessage(sender, recipient, content)
                            } catch {
                                console.log('error processing data: ' + message.toString());
                            }
                        });
                    }
                });
            });


        }

        // This function sends messages to the bouncer
        // TODO implement encryption handling, etc
        async function sendMessage() {

            let recipient;
            // Default to the selected user as the recipient
            if (document.querySelector("#recipient").value === '') {
                console.log("Implied recipient")
                recipient = location.href.split('#')[1];
            }
            else {
                recipient = document.querySelector("#recipient").value;
            }

            console.log(recipient);

            if (recipient === '') {
                return false;
            }

            async function sendMessage() {
                let recipient = document.querySelector("#recipient").value || location.href.split('#')[1];
                if (!recipient) return;

                const plaintext = document.getElementById("message").value;
                const keyBase64 = localStorage.getItem(`key-${recipient}`);
                if (!keyBase64) {
                    alert("Missing encryption key for this recipient.");
                    return;
                }

                // Store key in main process and get identifier + nonce
                const { identifier, nonce } = await ipcRenderer.invoke('store-key', { key: keyBase64 });

                // Encrypt full message
                const messageObject = {
                    sender: username,
                    recipient: recipient,
                    message: plaintext
                };

                const encrypted = await ipcRenderer.invoke('encrypt-message', {
                    message: JSON.stringify(messageObject),
                    key: keyBase64
                });

                // Create envelope with metadata for key lookup
                const envelope = {
                    identifier: identifier,
                    nonce: nonce,
                    payload: encrypted
                };

                await fetch(bouncerAddress, {
                    method: "POST",
                    body: JSON.stringify(envelope)
                });

                document.getElementById("message").value = '';
            }

            // Clear input field
            document.getElementById("message").value = '';
            // TODO add error checking
        }

        function receiveMessage(sender, recipient, message) {

            console.log("Processing message from:" + sender + " to " + recipient);

            let bounceBack = false; // bounceBack indicates if the message was sent from this client and bounced back from the server
            if (sender === username) { // message sent BY user
                bounceBack = true;
            }


            // Find the convo if it exists
            let existingConvoFound = false;
            let convo;
            Array.from(logArea.children).forEach((elem) => {

                // filter by the recipient if the message was sent by the client
                if (bounceBack && elem.id === recipient) {
                    existingConvoFound = true;
                    convo = elem;
                }

                else if (elem.id === sender) {
                    existingConvoFound = true;
                    convo = elem;
                }
            })

            // If the convo does not already exist, make a new one
            if (!existingConvoFound) {

                // Ensure convo target matches the remote user
                if (bounceBack) {
                    let newUser = document.createElement('div');
                    newUser.id = recipient;
                    newUser.classList.add('user-log');
                    newUser.innerHTML = "<h3>Chat history with <span>" + recipient + "</span></h3><ul class='message-log'></ul>";
                    convo = newUser;
                    logArea.appendChild(newUser);

                    let userLink = document.createElement('p');
                    userLink.innerHTML = `<a class="side-nav-item" href="#${recipient}">${recipient}</a>`;
                    userList.appendChild(userLink);
                }
                else {
                    let newUser = document.createElement('div');
                    newUser.id = sender;
                    newUser.classList.add('user-log');
                    newUser.innerHTML = "<h3>Chat history with <span>" + sender + "</span></h3><ul class='message-log'></ul>";
                    convo = newUser;
                    logArea.appendChild(newUser);

                    let userLink = document.createElement('p');
                    userLink.innerHTML = `<a class="side-nav-item" href="#${sender}">${sender}</a>`;
                    userList.appendChild(userLink);
                }
            }

            // Append the message to the conversation
            let newMessage = document.createElement('li');
            if (bounceBack) {
                newMessage.classList.add('own-message');
            }
            newMessage.innerText = message;
            if (convo.children[1].firstChild) {
                convo.children[1].insertBefore(newMessage, convo.children[1].firstChild);
            }
            else {
                convo.children[1].appendChild(newMessage);
            }

            // Adjust scroll if currently targeting the convo
            if (location.href.split('#')[1] === convo.id) {
                convo.children[1].scrollTop = convo.children[1].scrollHeight;
            }
        }

        // Puts new messages up in the response area
        ipcRenderer.on("message-received", (event, message) => {
            (async () => {
                const { payload, identifier, nonce } = JSON.parse(message['data']);
                const foundKeyBase64 = await ipcRenderer.invoke('find-key', {
                    identifier: identifier,
                    nonce: nonce
                });

                if (!foundKeyBase64) {
                    console.warn("Decryption key not found for identifier:", identifier);
                    return;
                }

                const decrypted = await ipcRenderer.invoke('decrypt-message', {
                    encrypted: payload,
                    key: foundKeyBase64
                });
            
                const { sender, recipient, message: content } = JSON.parse(decrypted);
                receiveMessage(sender, recipient, content);
            })();

            console.log(obj);
        });
    </script>
    </body>
</html>
