<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CryptSeek</title>
        <link rel="stylesheet" href="./styles.css">
    </head>

    <body>
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>My Messages</h2>
            <div id="user-list">
                <p>
                    <!-- Links generated by loaded messages -->
                </p>
            </div>
        </div>

        <!-- Main content -->

        <!-- Navbar -->
        <div class="main-content">
            <nav class="top-nav">
                <img src="./logo.png" style="width: 200px; text-align: left;"
                    alt="CryptSeek Logo">
                <div style="text-align: right;">
                    <a class="top-nav-item" href="settings.html">Settings</a>
                </div>
            </nav>

            <div style="color: lime; padding: 50px; text-align: center;">
                <h2>Welcome to CryptSeek!</h2>
                <p>Send and receive messages securely.</p>
            </div>

            <!-- Send Message Box -->
            <div class="info-box">
                <h3 style="margin: 5px 0px 15px 0px; text-align: center;">Send a Message</h3>
                <label for="recipient">Recipient: </label>
                <input type="text" id="recipient"
                    placeholder="Username of recipient">
                <p></p>
                <label for="message">Message: </label>
                <input id="message" type="text" placeholder="Enter a message">
                <button onclick="sendMessage()">Send</button>
            </div>

            <div id="message-log" style="color: white;">
                <!-- Generate areas based on received message senders -->
            </div>
        </div>

        <script>
        const { ipcRenderer } = require("electron");
        const Store = require('electron-store');
        const fs = require('fs');

        // DOM objects for showing messages
        const logArea = document.getElementById('message-log');
        const userList = document.getElementById('user-list').children[0];

        const store = new Store();
        const bouncerAddress = store.get('bouncerAddress');
        const gatewayAddress = store.get('gatewayAddress');
        const username = store.get('username');

        // Persistent File handling
        let dataPath = '';
        ipcRenderer.on('path-relay', (event, data) => {
            dataPath = data['data'];
            loadStoredMessages();
        });

        if (dataPath === '') {
            ipcRenderer.send('get-path');
        }

        function loadStoredMessages() {
            fs.readFile(`${dataPath}/messages.jsonl`, {encoding: 'utf-8'}, (err, data) => {
                if (!err) {
                    let messages = data.split('\n');
                    messages.forEach(message => {
                        const obj = JSON.parse(message);
                        const sender = obj['sender'];
                        const recipient = obj['recipient'];
                        const content = obj['message'];

                        receiveMessage(sender, content)
                    });
                }
            });
        }

        // This function sends messages to the bouncer
        // TODO implement encryption handling, etc
        async function sendMessage() {
            const recipient = document.querySelector("#recipient").value;
            const content = document.getElementById("message").value;

            const message = `{"sender": "${username}","recipient": "${recipient}", "message": "${content}"}`;

            const response = fetch(bouncerAddress, {method: "POST", body: message});
            // TODO add error checking
        }

        function receiveMessage(sender, message) {
            // Check if logarea already contains a div for member
            let existingConvoFound = false;
            let targetElem;
            Array.from(logArea.children).forEach((elem) => {
                if (elem.id === sender) {
                    existingConvoFound = true;
                    targetElem = elem;
                }
            })
            if (!existingConvoFound) {
                // make a new conversation element
                let newUser = document.createElement('div');
                newUser.id = sender;
                newUser.classList.add('user-log');
                newUser.innerHTML = "<h3>" + sender + "</h3><ul class='message-log'></ul>";
                targetElem = newUser;
                logArea.appendChild(newUser);

                let userLink = document.createElement('p');
                userLink.innerHTML = `<a class="side-nav-item" href="#${sender}">${sender}</a>`;
                userList.appendChild(userLink);
            }

            // Put the message in the right place
            let newMessage = document.createElement('li');
            newMessage.innerText = message;
            targetElem.children[1].appendChild(newMessage);
        }

        // Puts new messages up in the response area
        ipcRenderer.on("message-received", (event, message) => {
            const obj = JSON.parse(message['data']);
            const sender = obj['sender'];
            const recipient = obj['recipient'];
            const content = obj['message'];

            // Write message to data file
            fs.appendFile(`${dataPath}/messages.jsonl`, `${message['data']}\n`, (err) => {
                if (err) {
                    console.log('error', err);
                }
            });

            receiveMessage(sender, content)

            console.log(obj);
        });
    </script>
    </body>
</html>
