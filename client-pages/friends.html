<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptSeek</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="body-flex">

        <div class="sidebar">
            <h2>My Messages</h2>
            <div id="user-list">
                <p>
                    <!-- Links generated by loaded messages -->
                </p>
            </div>
        </div>

        <div class="main-content">
            <nav class="top-nav">
                <img src="./logo.png" style="width: 200px; text-align: left;"
                     alt="CryptSeek Logo">
                <div style="text-align: right;">
                    <a class="top-nav-item" href="index.html">Home</a>
                    <a class="top-nav-item" href="settings.html">Settings</a>
                </div>
            </nav>

            <div class="message-content-area">
                <!-- Debug Box -->
                <div class="info-box">
                    <h3 style="margin: 5px 0 15px 0; text-align: center;">Debug Field Area</h3>
                    <label for="recipient">Recipient: </label>
                    <input type="text" id="recipient"
                           placeholder="Username of recipient">
                </div>

                <div id="message-log">
                    <!-- Generate areas based on received message senders -->
                </div>
            </div>

        </div>
    </div>
</body>

<script>
    const { ipcRenderer } = require("electron");
    const Store = require('electron-store');
    const fs = require('fs');

    // DOM objects for showing messages
    const logArea = document.getElementById('message-log');
    const userList = document.getElementById('user-list').children[0];

    const store = new Store();
    const bouncerAddress = store.get('bouncerAddress');
    const username = store.get('username');

    // Persistent File handling
    let dataPath = '';
    ipcRenderer.on('path-relay', (event, data) => {
        dataPath = data['data'];
        loadStoredMessages();

        console.log("Setting settings content")

        // TODO add "New Friend" button
    });

    if (dataPath === '') {
        ipcRenderer.send('get-path');
    }

    function receiveMessage(sender, recipient, message) {

        console.log("Processing message from:" + sender + " to " + recipient);

        let bounceBack = false; // bounceBack indicates if the message was sent from this client and bounced back from the server
        if (sender === username) { // message sent BY user
            bounceBack = true;
        }


        // Find the convo if it exists
        let existingConvoFound = false;
        let convo;
        Array.from(logArea.children).forEach((elem) => {

            // filter by the recipient if the message was sent by the client
            if (bounceBack && elem.id === recipient) {
                existingConvoFound = true;
                convo = elem;
            }

            else if (elem.id === sender) {
                existingConvoFound = true;
                convo = elem;
            }
        })

        // If the convo does not already exist, make a new one
        if (!existingConvoFound) {

            // Ensure convo target matches the remote user
            if (bounceBack) {
                let newUser = document.createElement('div');
                newUser.id = recipient;
                newUser.classList.add('user-log');
                newUser.innerHTML = "<h3>Settings for <span>" + recipient + "</span></h3>";
                convo = newUser;
                logArea.appendChild(newUser);

                let userLink = document.createElement('p');
                userLink.innerHTML = `<a class="side-nav-item" href="#${recipient}">${recipient}</a>`;
                userList.appendChild(userLink);
            }
            else {
                let newUser = document.createElement('div');
                newUser.id = sender;
                newUser.classList.add('user-log');
                newUser.innerHTML = "<h3>Settings for <span>" + sender + "</span></h3>";
                convo = newUser;
                logArea.appendChild(newUser);

                let userLink = document.createElement('p');
                userLink.innerHTML = `<a class="side-nav-item" href="#${sender}">${sender}</a>`;
                userList.appendChild(userLink);
            }
        }
    }

    function loadStoredMessages() {
        fs.readFile(`${dataPath}/messages.jsonl`, {encoding: 'utf-8'}, (err, data) => {
            if (!err) {
                let messages = data.split('\n');
                messages.forEach(message => {
                    try {
                        const obj = JSON.parse(message);
                        const sender = obj['sender'];
                        const recipient = obj['recipient'];
                        const content = obj['message'];
                        receiveMessage(sender, recipient, content)
                    } catch {
                        console.log('error processing data: ' + message.toString());
                    }
                });
            }
        });
    }

    function removeFriend(event) {
        console.log("Not implemented", event.target.id);
    }

</script>

</html>