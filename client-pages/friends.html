<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptSeek - Friends</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
<div class="body-flex">

    <!-- Sidebar with friend list -->
    <div class="sidebar">
        <h2>My Friends</h2>
        <div id="user-list">
            <p>
                <!-- Links generated dynamically -->
            </p>
        </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
        <nav class="top-nav">
            <img src="./logo.png" style="width: 200px; text-align: left;" alt="CryptSeek Logo">
            <h1>Your Friends</h1>
            <div style="text-align: right;">
                <a class="top-nav-item" href="index.html">Home</a>
                <a class="top-nav-item" href="settings.html">Settings</a>
            </div>
        </nav>

        <div class="message-content-area">

            <!-- Add Friend UI -->
            <div class="info-box">
                <h3 style="margin: 5px 0 15px 0; text-align: center;">Add a New Friend</h3>
                <input type="text" id="new-friend-name" placeholder="Friend's username">
                <button class="btn btn-success" onclick="addFriend()">Add Friend</button>
            </div>

            <!-- List of existing friends -->
            <div id="message-log">
                <!-- Dynamic friend entries -->
            </div>
        </div>
    </div>
</div>

<script>
    const { ipcRenderer } = require("electron");
    const Store = require('electron-store');
    const fs = require('fs');

    const logArea = document.getElementById('message-log');
    const userList = document.getElementById('user-list').children[0];

    const store = new Store();
    const username = store.get('username');
    let dataPath = '';

    ipcRenderer.on('path-relay', (event, data) => {
        dataPath = data['data'];
        loadFriends();
    });

    if (dataPath === '') {
        ipcRenderer.send('get-path');
    }

    function loadFriends() {
        const friends = fs.readdirSync(`${dataPath}/data`);
        friends.forEach((friend) => {
            if (friend !== username) {
                createFriendEntry(friend);
            }
        });
    }

    function createFriendEntry(friendName) {
        // Add to main log
        let newUser = document.createElement('div');
        newUser.id = friendName;
        newUser.classList.add('user-log');
        newUser.innerHTML = `
            <h3>Settings for <span>${friendName}</span></h3>
            <div>
                <button class='btn btn-warning' id='rem-${friendName}'>Remove Friend</button>
            </div>
        `;
        logArea.appendChild(newUser);

        newUser.querySelector(`#rem-${friendName}`).addEventListener('click', removeFriend);

        // Add to sidebar
        let userLink = document.createElement('p');
        userLink.innerHTML = `<a class="side-nav-item" href="#${friendName}">${friendName}</a>`;
        userLink.id = `link-${friendName}`;
        userList.appendChild(userLink);
    }

    function addFriend() {
        const input = document.getElementById("new-friend-name");
        const friendName = input.value.trim();
        if (friendName === '' || friendName === username) return;

        const friendDir = `${dataPath}/data/${friendName}`;
        if (!fs.existsSync(friendDir)) {
            fs.mkdirSync(friendDir);
            fs.writeFileSync(`${friendDir}/messages.jsonl`, '');
            createFriendEntry(friendName);
        }
        input.value = '';
    }

    function removeFriend(event) {
        const button = event.target;
        const friendName = button.id.replace('rem-', '');
        const friendDir = `${dataPath}/data/${friendName}`;

        if (fs.existsSync(friendDir)) {
            fs.rmdirSync(friendDir, { recursive: true });

            // Remove elements from DOM
            const convo = document.getElementById(friendName);
            if (convo) convo.remove();

            const link = document.getElementById(`link-${friendName}`);
            if (link) link.remove();
        }
    }
</script>
</body>
</html>
