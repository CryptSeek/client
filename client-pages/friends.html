<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptSeek</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="body-flex">

        <div class="sidebar">
            <h2>My Friends</h2>
            <div id="user-list">
                <div>
                    <p><a class="side-nav-item" style="margin-bottom: 1em;" href="#cs-add-friend">Add a Friend</a></p>
                    <!-- Links generated by loaded messages -->
                </div>
            </div>
            <div>
                <h3>Blocked Users</h3>
                <div id="blocked-users-list">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>



        <div class="main-content">
            <nav class="top-nav">
                <img src="./logo.png" style="width: 200px; text-align: left;"
                     alt="CryptSeek Logo">
                <h1>Your Friends</h1>
                <div style="text-align: right;">
                    <a class="top-nav-item" style="margin-right: 10px;" href="index.html">Home</a>
                    <span class="top-nav-item" style="margin-right: 10px;">Friends</span>
                    <a class="top-nav-item" style="margin-right: 10px;" href="settings.html">Settings</a>
                    <a class="top-nav-item" style="margin-right: 10px;" href="about.html">About</a>
                </div>
            </nav>

            <div class="message-content-area">
                <div id="message-log">
                    <div id="cs-add-friend" >
                        <div class="info-box">
                            <h3>Add a friend:</h3>
                            <div>
                                <h4>Steps:</h4>
                                <ol>
                                    <li>Ask your friend for their CryptSeek token</li>
                                    <li>Paste a token here to add a friend: <br>
                                        <label for="friend-token" hidden>Friend Token</label>
                                        <input placeholder="Paste token here..." type="text" id="friend-token">
                                    </li>
                                    <li style="margin-top: 5px;"><button class="btn btn-primary" onclick="acceptFriendToken()">Add Friend With Token</button></li>
                                </ol>
                                <button class="btn btn-primary" onclick="copyMyToken()">Copy My Token</button>
                                <button id="reset-rsa-btn" class="btn btn-warning" style="margin-top: 1em;">Reset My Friend Token</button>
                                <p id="copy-status" class="blend-in-info">Token copied to clipboard!</p>
                            </div>
                        </div>
                    </div>
                    <!-- Generate areas based on received message senders -->
                </div>
            </div>

        </div>
    </div>
</body>

<script>
    const { ipcRenderer, clipboard } = require("electron");
    const Store = require('electron-store');
    const fs = require('fs');
    const Dialogs = require('dialogs');
    const dialogs = Dialogs();

    // DOM objects for showing messages
    const logArea = document.getElementById('message-log');
    const userList = document.getElementById('user-list').children[0];
    const blockedUserList = document.getElementById('blocked-users-list');

    const store = new Store();
    const bouncerAddress = store.get('bouncerAddress');
    const username = store.get('username');

    // Load friends from storage
    let dataPath = '';
    ipcRenderer.on('path-relay', (event, data) => {
        dataPath = data['data'];

        let friends = fs.readdirSync(`${dataPath}/data`);
        friends.forEach((friend) => {

            let newUser = document.createElement('div');
            newUser.id = friend;
            newUser.classList.add('user-log');

            const statusFile = `${dataPath}/data/${friend}/status`;
            let status;
            try {
                status = JSON.parse(fs.readFileSync(statusFile).toString())['status'];
            } catch (e) {
                status = 0;
            }

            let userLink = document.createElement('p');
            userLink.classList.add('side-nav-p')
            userLink.innerHTML = `<a class="side-nav-item" href="#${friend}">${friend}</a>`;

            if (status !== 4) {
                newUser.innerHTML = "<h3>Settings for <span>" + friend + "</span></h3>" +
                    "<div>" +
                    "<button class='btn btn-warning'>Remove Friend</button>" +
                    "</div>";

                newUser.children[1].firstChild.id = "rem-" + friend;
                newUser.children[1].firstChild.addEventListener('click', removeFriend);
                userList.appendChild(userLink);

            } else {
                newUser.innerHTML = "<h3>Settings for <span>" + friend + "</span></h3>" +
                    "<div>" +
                    "<button class='btn btn-warning'>Unblock</button>" +
                    "</div>";

                newUser.children[1].firstChild.id = "unblock-" + friend;
                newUser.children[1].firstChild.addEventListener('click', (event) => {
                    const name = event.target.id.split('-')[1];
                    const statusFile = `${dataPath}/data/${name}/status`;
                    fs.writeFileSync(statusFile, JSON.stringify({status: 3}));
                    location.reload();
                });
                blockedUserList.appendChild(userLink);
            }

            logArea.appendChild(newUser);
        });
    });

    if (dataPath === '') {
        ipcRenderer.send('get-path');
    }

    async function removeFriend(event) {
        console.log(event.target);
        let friendName = event.target.parentNode.parentNode.id;
        if (await dialogs.confirm("Are you sure you want to remove this friend\nThis cannot be undone!")) {
            fs.rmSync(`${dataPath}/data/${friendName}`, {recursive: true});
            window.location.reload();
        }
    }

    async function copyMyToken() {
        const status = document.getElementById("copy-status");
        try {
            window.focus();
            const token = await ipcRenderer.invoke('get-public-key-token', { username });
            await navigator.clipboard.writeText(token);
            status.classList.remove('blend-in-info');
            setTimeout(() => { status.classList.add('blend-in-info'); }, 3000);
        } catch (err) {
            console.error("Clipboard write failed:", err);
            status.innerText = "Failed to copy token.";
            status.classList.add('fail');
            setTimeout(() => {
                status.innerText = "Token copied to clipboard!";
                status.classList.add('blend-in-info');
                status.classList.remove('fail');
                }, 3000);
        }
    }

    async function acceptFriendToken() {
        const tokenInput = document.getElementById("friend-token").value;
        try {
            const tokenString = atob(tokenInput);
            const tokenObj = JSON.parse(tokenString);

            const friendUsername = tokenObj.username;
            const friendPublicKey = tokenObj.pubkey;

            const aesKey = crypto.getRandomValues(new Uint8Array(32));
            const aesKeyBase64 = btoa(String.fromCharCode(...aesKey));

            // Encrypt full message object (sender, recipient, message)
            const messageObject = {
                sender: username,
                recipient: friendUsername,
                message: "New Friend Request from " + username,
                key: aesKeyBase64,
            };

            ipcRenderer.send('send-asym-message', messageObject, friendPublicKey);

            const friendFolder = `${dataPath}/data/${friendUsername}`;
            if (!fs.existsSync(friendFolder)) {
                fs.mkdirSync(friendFolder);
            }

            fs.writeFileSync(`${friendFolder}/pubkey`, friendPublicKey);

            fs.appendFile(`${friendFolder}/messages.jsonl`, `${JSON.stringify(messageObject)}\n`, (err) => {
                if (err) console.error('Error writing message to file:', err);
            });

            const keyFile = `${dataPath}/data/${friendUsername}/key`;
            fs.writeFileSync(keyFile, aesKeyBase64);

            await ipcRenderer.invoke('store-aes-key', aesKeyBase64, friendUsername);

            dialogs.alert("Friend Request Sent");

        } catch (err) {
            console.error("Failed to parse or send friend token:", err);
            dialogs.alert("Invalid Friend Token")
        }
    }

    document.getElementById("reset-rsa-btn").addEventListener("click", async () => {
        const confirmReset = await dialogs.confirm("Resetting your Friend Token will invalidate your old Friend Token\nThis Cannot Be Undone");
        if (!confirmReset) return;

        const newPublicKey = await ipcRenderer.invoke("reset-rsa-keypair");
        dialogs.alert("New Friend Token Generated")
    });

</script>

</html>