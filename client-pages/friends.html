<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptSeek</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="body-flex">

        <div class="sidebar">
            <h2>My Friends</h2>
            <div id="user-list">
                <div>
                    <p><a class="side-nav-item" style="margin-bottom: 1em;" href="#cs-add-friend">Add a Friend</a></p>
                    <!-- Links generated by loaded messages -->
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>Blocked Users</h3>
            <ul id="blocked-users-list">
                <!-- Filled dynamically -->
            </ul>
        </div>

        <div class="main-content">
            <nav class="top-nav">
                <img src="./logo.png" style="width: 200px; text-align: left;"
                     alt="CryptSeek Logo">
                <h1>Your Friends</h1>
                <div style="text-align: right;">
                    <a class="top-nav-item" href="index.html">Home</a>
                    <a class="top-nav-item" href="settings.html">Settings</a>
                </div>
            </nav>

            <div class="message-content-area">
                <div id="message-log">
                    <div id="cs-add-friend" class="info-box">
                        <h3>Add a friend:</h3>
                        <div>
                            <h4>Steps:</h4>
                            <ol>
                                <li>Ask your friend for their CryptSeek token</li>
                                <li><button onclick="copyMyToken()">Copy My Token</button></li>
                                <li>Paste a token here to add a friend: <br><input placeholder="Paste token here..." type="text" id="friend-token"></li>
                                <li><button onclick="acceptFriendToken()">Add Friend</button></li>
                                <button id="reset-rsa-btn" class="btn btn-danger" style="margin-top: 1em;">Reset My RSA Key Pair</button>
                            </ol>
                        </div>
                    </div>
                    <!-- Generate areas based on received message senders -->
                </div>
            </div>

        </div>
    </div>
</body>

<script>
    const { ipcRenderer } = require("electron");
    const Store = require('electron-store');
    const fs = require('fs');

    // DOM objects for showing messages
    const logArea = document.getElementById('message-log');
    const userList = document.getElementById('user-list').children[0];

    const store = new Store();
    const bouncerAddress = store.get('bouncerAddress');
    const username = store.get('username');

    // Load friends from storage
    let dataPath = '';
    ipcRenderer.on('path-relay', (event, data) => {
        dataPath = data['data'];

        let friends = fs.readdirSync(`${dataPath}/data`);
        friends.forEach((friend) => {

            let newUser = document.createElement('div');
            newUser.id = friend;
            newUser.classList.add('user-log');
            newUser.innerHTML = "<h3>Settings for <span>" + friend + "</span></h3>" +
                "<div>" +
                "<button class='btn btn-warning'>Remove Friend</button>" +
                "</div>";
            logArea.appendChild(newUser);

            newUser.children[1].firstChild.id = "rem-" + friend;
            newUser.children[1].firstChild.addEventListener('click', removeFriend);

            let userLink = document.createElement('p');
            userLink.classList.add('side-nav-p')
            userLink.innerHTML = `<a class="side-nav-item" href="#${friend}">${friend}</a>`;
            userList.appendChild(userLink);
        });
    });

    if (dataPath === '') {
        ipcRenderer.send('get-path');
    }

    function removeFriend(event) {
        console.log(event.target);
        let friendName = event.target.parentNode.parentNode.id;
        if (confirm("Are you sure you want to remove this friend\nThis cannot be undone!")) {
            fs.rmSync(`${dataPath}/data/${friendName}`, {recursive: true});
            window.location.reload();
        }
    }

    async function copyMyToken() {
        try {
            window.focus();
            const token = await ipcRenderer.invoke('get-public-key-token', { username });
            await navigator.clipboard.writeText(token);
            alert("Your CryptSeek token has been copied to your clipboard!");
        } catch (err) {
            console.error("Clipboard write failed:", err);
            alert("Failed to copy token. Try focusing the window first.");
        }
    }

    async function acceptFriendToken() {
        const tokenInput = document.getElementById("friend-token").value;
        try {
            const tokenString = atob(tokenInput);
            const tokenObj = JSON.parse(tokenString);

            const friendUsername = tokenObj.username;
            const friendPublicKey = tokenObj.pubkey;

            const aesKey = crypto.getRandomValues(new Uint8Array(32));
            const aesKeyBase64 = btoa(String.fromCharCode(...aesKey));

            // Encrypt full message object (sender, recipient, message)
            const messageObject = {
                sender: username,
                recipient: friendUsername,
                message: "New Friend Request from " + username,
                key: aesKeyBase64,
            };

            ipcRenderer.send('send-asym-message', messageObject, friendPublicKey);

            const friendFolder = `${dataPath}/data/${friendUsername}`;
            if (!fs.existsSync(friendFolder)) {
                fs.mkdirSync(friendFolder);
            }

            fs.writeFileSync(`${friendFolder}/pubkey`, friendPublicKey);

            fs.appendFile(`${friendFolder}/messages.jsonl`, `${JSON.stringify(messageObject)}\n`, (err) => {
                if (err) console.error('Error writing message to file:', err);
            });

            const keyFile = `${dataPath}/data/${friendUsername}/key`;
            fs.writeFileSync(keyFile, aesKeyBase64);

            await ipcRenderer.invoke('store-aes-key', aesKeyBase64, friendUsername);

            alert("Friend Request Sent");

        } catch (err) {
            console.error("Failed to parse or send friend token:", err);
            alert("Invalid token.");
        }
    }

    document.getElementById("reset-rsa-btn").addEventListener("click", async () => {
        const confirmReset = confirm("Are you sure? Resetting your RSA key will prevent old friends from messaging you.");
        if (!confirmReset) return;

        const newPublicKey = await ipcRenderer.invoke("reset-rsa-keypair");
        alert("New RSA key pair generated! Be sure to send your updated token to your friends.");
    });

</script>

</html>